# 指南

無限城最初的構想來自於 excel ，excel 爲什麼這麼強大呢？它的核心價值就在於「能夠使用函式」，函式與其他儲存格連動，就能實現各種不同的統計功能。然而無限城是個論壇系統（社群網站），它是以一篇篇的文章作爲內容主體，所以若要對應到 excel ，無限城的「儲存格」在哪裡呢？最簡單的切割法就是，文章是一個儲存格、每則留言也是一個儲存格，所以顯而易見的，無限城中最簡單的應用就是投票，只要在文章中寫一個統計函式，什麼「喜歡灌籃高手還是宅男打籃球？」、「大家都幾歲學會騎腳踏車？」這種問問題的文章就能輕易統計出來。

無限城的功能還有很多，但我們先來演示一下投票文再繼續討論其他功能是如何慢慢演化出來的。


歡迎讀者在閱讀的同時，也一起動手跟著做，如此學習效果會更好。當然，記得先[註冊帳號](https://city-of-infinity.com/app/start-verify)，創板、發文、留言等功能都得登入才能使用。

同時**注意**， 根看板不能發文，建議先進入[測試](https://city-of-infinity.com/app/b/%E6%B8%AC%E8%A9%A6)板，或自行建立一個看板之後再來慢慢測試。

## 使用函式（範例：投票文）

### 步驟一：先創建看板，設定文章表單格式
若想要在文章中使用函式，必須在文章所在的看板下先行設定，所以我們首先來創建一個看板：

點擊「創建看板」後，先隨意填寫看板名稱。

除了看板名稱之外，我們還會看到三個可以展開的規則，請展開表單規則，將文章表單規則->欄位1中原本寫着「字串（單純文字）」的下拉式選單改成「函式」。如下圖所示：

![改字串爲函式](http://i.imgur.com/4J7oDvG.png)

其他全部保持不動，拉到底下按送出，要是無法送出大概是因爲你填寫的看板名稱已經存在，請換個名稱再試一次。

### 步驟二：在新看板發表文章，並在文章內容中使用函式

接下來我們要撰寫函式，無限城採用 JavaScript 語言，這讓使用者提交的函式能直接被瀏覽器 eval 之後執行，此做法當然存在安全上的風險，這方面的問題容後再述。

也許要學會寫程式必須先做上許多前置工作（架設環境、熟悉語法），但想要看懂簡短的程式是很簡單的，尤其無限城中需要撰寫的程式多半只是字串處理，不會涉及到計算機的系統或是較深入的數學，以下我會多做註解，並盡量以中文命名變數，讓不會寫程式或是上過一堂程式設計課但已荒廢許久的讀者也能看懂。

現在我們在新看板點發文按鈕，複製貼上以下程式碼到文章內容

``` javascript
function(data) {
	// 宣告兩個變數
	let 宅男打籃球票數 = 0;
	let 灌籃高手票數 = 0;
	// 將一個個留言取出檢視
	for (let comment of data.comments) {
		if (comment.content["內容"] == "宅男打籃球") {
			// 若留言內容爲"宅男打籃球"，「宅男打籃球票數」此一變數值加一
			宅男打籃球票數 += 1;
		} else if (comment.content["內容"] == "灌籃高手") {
			// 若留言內容爲"灌籃高手"，「灌籃高手票數」此一變數值加一
			灌籃高手票數 += 1;
		}
	}
	// 在 JavaScript 中
	// 以「`」反引號所夾起的字串能用「${變數名}」來嵌入變數
	// 此時該變數會被自動轉換成字串塞入${變數名}所佔據的位置
	// 最終回傳一個字串
	return `宅男打籃球: ${宅男打籃球票數}票, 灌籃高手: ${灌籃高手票數}票`;
}
```

如果你喜歡函數式的做法也可以用

``` javascript
function(data) {
	// 先以 filter 方法過濾出內容是"宅男打籃球"的留言，再計算這些留言所組成之陣列的長度
	let 宅男打籃球票數 = data.comments.filter(comment => comment.content["內容"] == "宅男打籃球").length;
	// 類似於上一行
	let 灌籃高手票數 = data.comments.filter(comment => comment.content["內容"] == "灌籃高手").length;
	return `宅男打籃球: ${宅男打籃球票數}票, 灌籃高手: ${灌籃高手票數}票`;
}
```
以上兩個版本的函式的效果完全等價，它們都同樣會統計底下留言留的「宅男打籃球」和「灌籃高手」各有多少個。而這個函式的返回值正是文章的內容。

函式僅接收一個參數 data ，很遺憾我們無法用像 excel 一樣使用 (A1:A8) 這樣極簡的表達式，想要那樣做的話就得定義一套自己的小語言，在初始階段，我們就先用 JavaScript 原生的物件來表達數據。這個 data 物件不只能取得留言內容，還包含了幾乎本篇文章的所有資料，例如作者帳號、日期、留言者帳號等等，詳細請參見參考手冊中的[文章或留言中使用函式](https://github.com/MROS/infinite-city/blob/master/doc/%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A.md#文章或留言中使用函式)。

大概很多人會困惑於爲什麼在 `comment.content["內容"]` 要先取出 `content` 又拿出 `內容` 呢？這個問題在下一節會得到詳細解答，現在給出一個簡短的答案：一個留言可以由多個欄位組成，但在預設狀況下，由一個欄位組成，並且標籤名就是「內容」。

好的，如果操作正確，這時候網頁會是這樣：

![發篇投票文](http://i.imgur.com/DbeZ8kL.png)

一樣往下拉按送出。順利的話就會看到文章頁面：

![投票文](http://i.imgur.com/2MDOgkO.png)

因爲現在沒有任何留言，因此兩方的票數都是 0。

### 步驟三：實際留言測試

實際留言之後，會看到：

![留言後](http://i.imgur.com/1kbGm2X.png)

我們的投票文成功了！而且在這過程中，官方都無需添加任何的程式碼，所有的邏輯都由一般用戶所提供。

## 文章、留言格式限制

### 限制函式（範例：投票文增強版）

讀者可能很快就會發現，要是留言並不與"宅男打籃球"或是"灌籃高手"完全符合，例如說這樣：

![不被統計到的留言](http://i.imgur.com/z7dplYP.png)

那這則留言就不會被統計到。

這我們可以透過增強統計票數的那個函式來解決，譬如說只要整個留言中出現漫畫名稱就把它算進去，但如果是這種「宅男打籃王求」這種拆字啦、或是留言中兩個漫畫名都有出現啦，那就很難去分辨，因此無限城讓發文者能夠限制留言的內容，當然，也是讓用戶自行撰寫函式來達成此功能。

我們重發一篇文章，先進行與上回相同的操作，然後打開表單規則，在留言表單規則的限制條件中，加上以下程式碼：

``` javascript
function (cur) {
	// "||" 在 JavaScript 中表示 「或」
	if (cur == "宅男打籃球" || cur == "灌籃高手") {
		// 若留言與恰好是"宅男打籃球"或"灌籃高手"，回傳真
		return true;
	} else {
		// 否則回傳假
		return false;
	}
}
```

如下圖：
![留言限制](http://i.imgur.com/5lJgHEh.png)

再次送出文章，此時你會發現，已經無法送出不是這兩部漫畫名的留言了：
![畫紅線](http://i.imgur.com/8EZrxwe.png)

不符合格式的留言會被畫上紅色框框，點留言也會彈出警告。

回頭來解釋一下這個函式，`cur`是一個字串，代表留言內容，而接收這個字串後你就可以決定要回傳真或假，若回傳真，代表這個留言合法，若回傳假，代表留言不合法，無法發出這種內容的留言，我們透過這樣的機制，強迫了每個留言都是合法的投票。

### 多個欄位（範例：評價文）

上面是以留言爲例子，文章也能下限制函式，我們這次以文章來舉例，並介紹多欄位的格式。

如果每篇文章或每個留言都只有一個欄位，那用起來會很困擾，以一個電影評價文爲例好了，這篇電影評價文都必須包含：

- 電影名稱（不爲空）
- 分數（0~5）
- 影評（超過 50 字）

此時去撰寫限制函式來限制出我們想要的格式是很困難的，我們可能得這麼做：

``` javascript
// 1. 將內文依據換行切割成三部分
// 2. 檢查三部分是否各以「電影名稱」、「分數」、「影評」開頭
// 3. 檢查各部分的限制條件
```

這種做法很脆弱，換行切割如果限制爲只能空一行，空兩行的人就無法發文，而若空幾行都切割，又導致顯示出來的畫面不統一，而一旦以換行切割，影評中也需要換行啊！字串處理勢必會變得十分複雜。得十分詳細的閱讀這個函式，才能發文，如此會很困擾使用者。

如果我們在發文的使用者介面上就將這三個欄位切開，然後各自檢查限制條件，就輕鬆得多了。

好的，我們再開一個新的看板，這次我們修改文章表單規則，將第一欄的標籤名從預設的「內容」改爲「電影名稱」，點擊「更多欄位」的按鈕，額外添加兩個標籤名分別爲「分數」、「影評」的欄位，並使用以下的限制：

``` javascript
// 電影名稱限制
function (cur) {
	return cur.length > 0;
}
// 分數限制
function (cur) {
	return cur == "0" || cur == "1" || cur == "2" || cur == "3" || cur == "4" || cur == "5" ;
}
// 影評限制
function (cur) {
	return cur.length >= 50;
}
```

整個過程的展示，直接上 gif：

![創建電影評論版](http://i.imgur.com/xdtGJ5x.gifv)

現在發文時只要分別填寫三個欄位，皆符合條件的即可。

### 再談限制函式
限制函式其實可以吃兩個參數，第一個參數代表此欄位，第二個參數則代表所有欄位構成的一個 JavaScript 物件，它的鍵是欄位標籤名，值是該欄位標籤名對應的留言主體。

能夠擷取其他欄位會帶來更多彈性，例如說，我們可以限制只要在影評中寫到一個「爛」字，分數就只能是 0 分：

``` javascript
// 分數限制
function (cur, all) {
	// 若 search 方法找不到要搜尋的字串就會回傳 -1 ，"!=" 即爲「不等於」之義
	if (all["影評"].search("爛") != -1) {
		return cur == "0";
	} else {
	return cur == "0" || cur == "1" || cur == "2" || cur == "3" || cur == "4" || cur == "5" ;
	}
}
```

想瞭解更多限制函式的話，可以看參考手冊中的[表單規則](https://github.com/MROS/infinite-city/blob/master/doc/%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A.md#表單規則)

## 自定義渲染

## 權限限制

## 論無限城之有限性

## 無限城名字的典故

「剛好一分鐘，你做了個好夢嗎？」