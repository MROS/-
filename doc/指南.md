# 無限城指南

無限城最初的構想來自於 excel ，excel 爲什麼這麼強大呢？它的核心價值在於「能夠使用函式」，函式與其他儲存格連動，就能實現各種不同的統計功能。然而無限城是個論壇系統（社群網站），它是以一篇篇的文章作爲內容主體，所以若要對應到 excel ，無限城的「儲存格」在哪裡呢？最簡單的切割法就是，文章是一個儲存格、每則留言也是一個儲存格，所以顯而易見的，無限城中最簡單的應用就是投票，只要在文章中寫一個統計函式，什麼「喜歡灌籃高手還是宅男打籃球？」、「大家都幾歲學會騎腳踏車？」這種問問題的文章就能輕易統計出來。

無限城的功能還有很多，但我們先來演示一下投票文再繼續討論其他功能是如何慢慢演化出來的。


歡迎讀者在閱讀的同時，也一起動手跟著做，如此學習效果會更好。當然，記得先[註冊帳號](https://city-of-infinity.com/app/start-verify)，創板、發文、留言等功能都得登入才能使用。

同時**注意**， 根看板不能發文，建議先進入[測試](https://city-of-infinity.com/app/b/%E6%B8%AC%E8%A9%A6)板，或自行建立一個看板之後再來慢慢測試。

## 使用函式（範例：投票文）

### 步驟一：先創建看板，設定文章表單格式
若想要在文章中使用函式，必須在文章所在的看板下先行設定，所以我們首先來創建一個看板：

點擊「創建看板」後，先隨意填寫看板名稱。

除了看板名稱之外，我們還會看到三個可以展開的規則，請展開表單規則，將文章表單規則->欄位1中原本寫着「字串（單純文字）」的下拉式選單改成「函式」。如下圖所示：

![改字串爲函式](http://i.imgur.com/4J7oDvG.png)

其他全部保持不動，拉到底下按送出，要是無法送出大概是因爲你填寫的看板名稱已經存在，請換個名稱再試一次。

### 步驟二：在新看板發表文章，並在文章內容中使用函式

接下來我們要撰寫函式，無限城採用 JavaScript 語言，這讓使用者提交的函式能直接被瀏覽器 eval 之後執行，此做法當然存在安全上的風險，這方面的問題容後再述。

也許要學會寫程式必須先做上許多前置工作（架設環境、熟悉語法），但想要看懂簡短的程式是很簡單的，尤其無限城中需要撰寫的程式多半只是字串處理，不會涉及到計算機的系統或是較深入的數學，以下我會多做註解，並盡量以中文命名變數，讓不會寫程式或是上過一堂程式設計課但已荒廢許久的讀者也能看懂。

現在我們在新看板點發文按鈕，複製貼上以下程式碼到文章內容

``` javascript
function(data) {
	// 宣告兩個變數
	let 宅男打籃球票數 = 0;
	let 灌籃高手票數 = 0;
	// 將一個個留言取出檢視
	for (let comment of data.comments) {
		if (comment.content["內容"] == "宅男打籃球") {
			// 若留言內容爲"宅男打籃球"，「宅男打籃球票數」此一變數值加一
			宅男打籃球票數 += 1;
		} else if (comment.content["內容"] == "灌籃高手") {
			// 若留言內容爲"灌籃高手"，「灌籃高手票數」此一變數值加一
			灌籃高手票數 += 1;
		}
	}
	// 在 JavaScript 中
	// 以「`」反引號所夾起的字串能用「${變數名}」來嵌入變數
	// 此時該變數會被自動轉換成字串塞入${變數名}所佔據的位置
	// 最終回傳一個字串
	return `宅男打籃球: ${宅男打籃球票數}票, 灌籃高手: ${灌籃高手票數}票`;
}
```

如果你喜歡函數式的做法也可以用

``` javascript
function(data) {
	// 先以 filter 方法過濾出內容是"宅男打籃球"的留言，再計算這些留言所組成之陣列的長度
	let 宅男打籃球票數 = data.comments.filter(comment => comment.content["內容"] == "宅男打籃球").length;
	// 類似於上一行
	let 灌籃高手票數 = data.comments.filter(comment => comment.content["內容"] == "灌籃高手").length;
	return `宅男打籃球: ${宅男打籃球票數}票, 灌籃高手: ${灌籃高手票數}票`;
}
```
以上兩個版本的函式的效果完全等價，它們都同樣會統計底下留言留的「宅男打籃球」和「灌籃高手」各有多少個。而這個函式的返回值正是文章的內容。

函式僅接收一個參數 data ，很遺憾我們無法用像 excel 一樣使用 (A1:A8) 這樣極簡的表達式，想要那樣做的話就得定義一套自己的小語言，在初始階段，我們就先用 JavaScript 原生的物件來表達數據。這個 data 物件不只能取得留言內容，還包含了幾乎本篇文章的所有資料，例如作者帳號、日期、留言者帳號等等，詳細請參見參考手冊中的[文章或留言中使用函式](https://github.com/MROS/infinite-city/blob/master/doc/%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A.md#文章或留言中使用函式)。

大概很多人會困惑於爲什麼在 `comment.content["內容"]` 要先取出 `content` 又拿出 `內容` 呢？這個問題在下一節會得到詳細解答，現在給出一個簡短的答案：一個留言可以由多個欄位組成，但在預設狀況下，由一個欄位組成，並且標籤名就是「內容」。

好的，如果操作正確，這時候網頁會是這樣：

![發篇投票文](http://i.imgur.com/DbeZ8kL.png)

一樣往下拉按送出。順利的話就會看到文章頁面：

![投票文](http://i.imgur.com/2MDOgkO.png)

因爲現在沒有任何留言，因此兩方的票數都是 0。

### 步驟三：實際留言測試

實際留言之後，會看到：

![留言後](http://i.imgur.com/1kbGm2X.png)

我們的投票文成功了！而且在這過程中，官方都無需添加任何的程式碼，所有的邏輯都由一般用戶所提供。

## 文章、留言格式限制

### 限制函式（範例：投票文增強版）

讀者可能很快就會發現，要是留言並不與"宅男打籃球"或是"灌籃高手"完全符合，例如說這樣：

![不被統計到的留言](http://i.imgur.com/z7dplYP.png)

那這則留言就不會被統計到。

這我們可以透過增強統計票數的那個函式來解決，譬如說只要整個留言中出現漫畫名稱就把它算進去，但如果是這種「宅男打籃王求」這種拆字啦、或是留言中兩個漫畫名都有出現啦，那就很難去分辨，因此無限城讓發文者能夠限制留言的內容，當然，也是讓用戶自行撰寫函式來達成此功能。

我們重發一篇文章，先進行與上回相同的操作，然後打開表單規則，在留言表單規則的限制條件中，加上以下程式碼：

``` javascript
function (cur) {
	// "||" 在 JavaScript 中表示 「或」
	if (cur == "宅男打籃球" || cur == "灌籃高手") {
		// 若留言與恰好是"宅男打籃球"或"灌籃高手"，回傳真
		return true;
	} else {
		// 否則回傳假
		return false;
	}
}
```

如下圖：
![留言限制](http://i.imgur.com/5lJgHEh.png)

再次送出文章，此時你會發現，已經無法送出不是這兩部漫畫名的留言了：
![畫紅線](http://i.imgur.com/8EZrxwe.png)

不符合格式的留言會被畫上紅色框框，點留言也會彈出警告。

回頭來解釋一下這個函式，`cur`是一個字串，代表留言內容，而接收這個字串後你就可以決定要回傳真或假，若回傳真，代表這個留言合法，若回傳假，代表留言不合法，無法發出這種內容的留言，我們透過這樣的機制，強迫了每個留言都是合法的投票。

### 多個欄位（範例：評價文）

上面是以留言爲例子，文章也能下限制函式，我們這次以文章來舉例，並介紹多欄位的格式。

如果每篇文章或每個留言都只有一個欄位，那用起來會很困擾，以一個電影評價文爲例好了，每篇電影評價文都必須包含：

- 電影名稱（不爲空）
- 分數（0~5）
- 影評（超過 50 字）

此時去撰寫限制函式來限制出我們想要的格式是很困難的，我們可能得這麼做：

``` javascript
// 1. 將內文依據換行切割成三部分
// 2. 檢查三部分是否各以「電影名稱」、「分數」、「影評」開頭
// 3. 檢查各部分的限制條件
```

這種做法很脆弱，換行切割如果限制爲只能空一行，空兩行的人就無法發文，而若空幾行都切割，又導致顯示出來的畫面不統一，而一旦以換行切割，影評中也需要換行啊！字串處理勢必會變得十分複雜。得十分詳細的閱讀這個函式，才能發文，如此會很困擾使用者。

如果我們在發文的使用者介面上就將這三個欄位切開，然後各自檢查限制條件，就輕鬆得多了。

好的，我們再開一個新的看板，這次我們修改文章表單規則，將第一欄的標籤名從預設的「內容」改爲「電影名稱」，點擊「更多欄位」的按鈕，額外添加兩個標籤名分別爲「分數」、「影評」的欄位，並使用以下的限制：

``` javascript
// 電影名稱限制
function (cur) {
	return cur.length > 0;
}
// 分數限制
function (cur) {
	return cur == "0" || cur == "1" || cur == "2" || cur == "3" || cur == "4" || cur == "5" ;
}
// 影評限制
function (cur) {
	return cur.length >= 50;
}
```

整個過程的展示，直接上 gif：

![創建電影評論版](http://i.imgur.com/xdtGJ5x.gif)

現在發文時只要分別填寫三個欄位，皆符合條件的即可。

### 再談限制函式
限制函式其實可以吃兩個參數，第一個參數代表此欄位，第二個參數則代表所有欄位構成的一個 JavaScript 物件，它的鍵是欄位標籤名，值是該欄位標籤名對應的留言主體。

能夠擷取其他欄位會帶來更多彈性，例如說，我們可以限制只要在影評中寫到一個「爛」字，分數就只能是 0 分：

``` javascript
// 分數限制
function (cur, all) {
	// 若 search 方法找不到要搜尋的字串就會回傳 -1 ，"!=" 即爲「不等於」之義
	if (all["影評"].search("爛") != -1) {
		return cur == "0";
	} else {
		return cur == "0" || cur == "1" || cur == "2" || cur == "3" || cur == "4" || cur == "5" ;
	}
}
```

想瞭解更多限制函式的話，可以看參考手冊中的[表單規則](https://github.com/MROS/infinite-city/blob/master/doc/%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A.md#表單規則)

## 自定義渲染（評價文增強版）
如果適才有嘗試在新建立的電影影評板中發文的話，會發現最後文章頁的呈現效果並不盡如人意，有點難區別各個欄位，我們提供了一個渲染函式來修正最後呈現的樣子。

開一個新板，先與上一節的電影評論文相同操作，再打開渲染規則，填入：

``` javascript
function (content) {
	// 使用者的提交的所有資料都會儲存爲字串，因此先將其轉換爲數字
	const 分數 = parseInt(content["分數"]);
	return `
電影名稱：${content["電影名稱"]}

分數：${"★".repeat(分數)}

[[影評]]\n${content["影評"]}
`;
}
```
![渲染函式](http://i.imgur.com/ztMIG43.png)

試試發文，現在排版變漂亮、分數還會以萬國碼的「★」來表示囉！

想更瞭解渲染函式的話，請見參考手冊的[渲染規則](https://github.com/MROS/infinite-city/blob/master/doc/%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A.md#渲染規則)



## 權限限制

接下來要介紹的權限限制，與先前的渲染、限制函式的系統耦合度低，可以分開學習。

權限限制總共分為四種：

1. **發文:** 在發文的時候進行限制
2. **創建看板:** 在創建看板的時候進行限制
3. **留言:** 在留言的時候進行限制
4. **進入看板（文章）:** 在進入看板／文章的時候進行限制

### 繼承規則

試想一種狀況：鬧板哥因為素行不良，被 _清大板_ 永久水桶，禁止發文、留言與創板。然而，在清大板底下的 _清大電機板_ 裡，他仍擁有權限可以繼續鬧板,直到清大電機板的板主也水桶他……是不是有點不合理？

為了處理這個狀況，所有母看板定義的權限限制，都會被其子孫看板繼承，所以「鬧板哥已被水桶」這條規則也適用清大電機板。若在根看板中水桶某人，無異於全站封殺，逐出無限城。

### 參數

限制函數共有三個參數：

1. **cur_pos:** 當前的位置
2. **user_id:** 執行該行動的人的帳號
3. **definer:** 定義該規則的看板

底下用真實案例逐一說明。

### 案例一：無限城的根看板

做為一個看論壇最高的目錄，不可隨意在根看板發文應該是常識中的常識了。因此，我們在根目錄的 onNewArticle 中做了一些限制：

``` javascript
function(cur_pos) {
	// 丟出錯誤
	throw "不可褻瀆無限城的根";
}
```

"throw" 是 javascript 的關鍵字，會將這個字串「不可褻瀆無限城的根」當作一個錯誤拋出來給系統，系統收到以後就會做出處理。對於 onNewArticle 而言，所謂處理就是 **禁止人發文** 。

![發文慘遭禁止]( http://i.imgur.com/W7Ky47A.png)

然而由於繼承規則，這項限制將會在整個論壇的所有看板生效，換句話說，不論你在哪個看板發文，都只會得到「不可褻瀆無限城的根」的結果，這就是 cur_pos 派上用場的時候了。

cur_pos 是「current position，現在的位置」之縮寫，包含兩個成員： article 和 board。article 代表發出的文章，在這裡不會用到（因為不管發了啥文我們都不淮）。board 則代表「你現在身處的看板」。聽起來有點拗口？直接看應用吧：

``` javascript
function(cur_pos) {
	// 如果這個看板的深度為0，換句話說，它是根看板
	if(cur_pos.board.depth == 0) {
		// 丟出錯誤
		throw "不可褻瀆無限城的根";
	}
}
```

注意第三行，我們對 cur_pos.board 的深度做了一些判斷，假如我們現在處於根看板，深度就是0，自然會受到限制；假如我們處於根看板底下的八卦板，深度就是1而非0，因此不會再被規則所限制了。

經過這樣的修改，我們就可以在根看板以外的地方快樂的發文了。

如果再使用 user_id 參數，便可延伸出案例二。

### 案例二：無限城的根看板——真實版本

然而，根看板真的完全不能發文嗎？如果有什麼攸關整個無限城的重要公告（例如：[狂賀] 無限城居民數突破一百萬），po 在根看板不是很適合嗎？

如果給予根看板板主，也就是本人，發文的權限，就能輕鬆達成這個功能了。事實上如果檢視無限城的根看板，會發現案例一並不完整。真正的 onNewArticle 長這樣：

```javascript
function(cur_pos, user_id) {
	// 如果這個看板的深度為0，換句話說，它是根看板
	if(cur_pos.board.depth == 0) {
		// 如果發文的 id 不在板主名單內
		if(!cur_pos.board.manager.includes(user_id)) {
			throw "不可褻瀆無限城的根";
		}
	}
}
```

第四行程式碼有點複雜，讓我們慢慢研究它。

- 最開頭的驚嘆號!代表否定。
- cur_pos.board 和上例相同，代表身處的看板，而既然通過了第一個 if 陳述，代表深度為0，也就是根看板。
- manager 顧名思意代表板主群，是一個由板主們的帳號所組成的陣列。
- user_id 是執行行動（發文）的人的帳號。
- includes 是 javascript 的函數，用來確認某個變數是否包含在陣列之中。可以再舉幾個簡單的例子：
	``` javascript
	[1, 2, 3].includes(3); // true
	[1, 2, 3].includes(4); // false
	```

因此這段程式碼完整的意思是：「如果你的帳號**『不』**包含在板主群帳號之中，就會拋出錯誤」。

如果再引入第三個參數 definer，就能做出更廣泛的應用。

### 案例三：中華職棒板

假設今天有一個中華職棒板，其性質與根看板類似：本身只允許板主發文，下面有著「兄弟象」、「統一獅」等等子看板。我們可以直接抄根看板的規則來修改：

```javascript
function(cur_pos, user_id, definer) {
	// 如果這個看板的深度和中職板相同，換句話說，它就是中職板
	if(cur_pos.board.depth == definer.depth) {
		// 如果發文的 id 不在板主名單內
		if(!cur_pos.board.manager.includes(user_id)) {
			throw "不可褻瀆中職板";
		}
	}
}
```

改變的地方只有第三行，本來檢查深度是否等於0，改成檢查深度是否等於「definer.depth」。問題來了，definer 是什麼碗糕？

definer 也是一個看板，代表「定義這個規則的看板」，在這個案例中就是中職板。因為兄弟象板、統一獅板等等子板的深度一定大於它們的母看板，所以如果深度相等，那一定就是中職板本身了。

假如整個結構長這樣：

```bash
根看板           # 深度為0
├── 中華職棒板    # 中職板直屬於根看板，深度為1
│   ├─ 兄弟象板   # 各球隊直屬於中職板，深度為2
│   ├─ 統一獅板
.   .
.   .
```

那麼 definer.depth 永遠都是1，在深度為2的球隊板中發文就不會受到限制了。

### 動手時間

你已經有了全部的知識，可以在無限城裡建個你自己的中職板，或是 SBL 板之類的：

![創建新板](http://i.imgur.com/vAIxEwq.png)

去吧！

## 論無限城之有限性

「到底能多一般化？」
「要向使用者體驗靠攏。」

當我們在進行 API 設計之時，這兩方像是小天使與小惡魔般不斷的拉扯著我們，要操作最簡單的話，那勢必會可編程能力上不斷退讓！而想要最一般化的話，就買一台伺服器把金鑰公開，讓所有人 ssh 進來想幹嘛就幹嘛好啦！


## 無限城上的裂痕

無限城存在著顯而易見的安全漏洞，光是讓用戶提交 HTML 就夠危險了，更遑論 JavaScript 呢？爲了使前後端一致，限制函式在前端檢查一次之後，後端還會再次檢查（避免使用者直接針對 API 做 POST），稍微觀察一下源碼就能知道後端也是用 JavaScript (Node.js) 撰寫，因此只要針對後端 eval 時的語境就能實現打擊。在執行不安全來源程式碼的一般解法是，先將它置於一個沙盒，使它無法碰觸到外部造成破壞或偷取資料。

但無限城目前連這點防禦都沒有做到，不過開發者們都在此公開漏洞了，即使你以此攻克無限城，我們也不會承認你是了不起的駭客。

假設我們透過沙盒化達到安全性了，由於停機問題不可解，我們依然無法抵擋無窮迴圈，因此仍舊需要一種機制來限制使用者提交的函式能佔用的資源，可以是時間也可以是執行的指令集數目。即使能佔用的時間不長，由於 Node.js 的單線程特性，在那段時間內仍舊會使整個伺服器完全停擺，所以勢必得開出一支子進程來做，完結後回傳答案。

不可否認目前撰寫函式的體驗十分差勁，平常撰寫程式碼時會不斷進行測試，才能慢慢達到理想中的效果，但目前沒有預覽功能，因此所有程式碼需要使用者腦內編譯，十分辛苦。此外，JavaScript 身爲動態語言，雖然好寫，但也很容易產生型別錯誤，日後我們要作出什麼輔助工具時，也會因爲動態語言所提供資訊量不足而功能有限，而難以預料的執行期間錯誤，興許也會令使用者苦惱不已。而採用中文編程能降低門檻？綜上所述，我們也正考慮在 JavaScript 之上實作一套靜態強型別語言，希冀在解決安全性、調控資源的同時，也提高使用者體驗。

但實作一個語言真的是值得的嗎？還是使用現有語言加上沙盒就符合需求了呢？要投入的成本與所收到的成效，尚待權衡。

## 無限城名字的典故（徵才）

無限城是漫畫「閃靈二人組」中一座巨大的廢棄城市，是一個公權力無法觸及的無法地帶，犯罪者的天堂，分爲上中下層，下層由「雷帝」天野銀次與其手下「最惡少年幫派 VOLTS 四天王」所統治，後來天野銀次脫離 VOLTS ，與能使用邪眼的美堂蠻組成閃靈二人組(get backer)，以奪還專家的身份活躍著。

閃靈二人組已在無限城，四天王與專家們，我們正在等你。

目前無限城預計要完成的建築工作可拆分爲三份：

- 論壇本身，將加上個板與好友功能（增加一些社群網站的特性），並大幅度優化 UI ，使用戶不必僅回傳字串，也能有 HTML
- 即時通訊，需支援主流通訊軟體之功能，並盡可能設計出可編程之處
- 無限城腳本與模板語言，希望是一種靜態強型別語言

工作量不小，若招募不到開發者，進度會極爲緩慢甚至整個專案直接放棄。

我們也非常希望能招募到寫手，只要你能寫出文理通暢的文章，歡迎你與我們聯絡成爲先期作家，在建設初期能影響到無限城的未來走向，也能趁機認識朋友。

期待收到您的來信
0cityofinfinity0@gmail.com